<% condition = condition ||= nil %>

<div class="row condition-partial" style="margin-bottom: 10px;">
  <%
    action_type_arr = [["removes", :remove], ["adds notification", :add_webhook]]
    # name_start = "conditions[]condition_" + condition_no.to_s
    name_start = "conditions[#{condition_no.to_s}]"
    remove_question_collection = later_question_list(question)
    condition_exists = local_assigns.has_key? :condition
    type_default = condition_exists ? (condition[:action_type] == "remove" ? :remove : :add_webhook) : :remove
    remove_question_group = condition_exists ?
      grouped_options_for_select(remove_question_collection, condition[:remove_question_id]) :
      grouped_options_for_select(remove_question_collection)
    multiple = (question.question_format.multiselectbox? || question.question_format.checkbox?)
  %>

  <%# If this is a new condition then display the interactive controls. otherwise just display the logic %>
  <% if condition.nil? %>
    <div class="col-md-3">
      <%= select_tag(:question_option, options_from_collection_for_select(question.question_options.sort_by(&:number), "id", "text",
          condition_exists ? condition[:question_option_id] : question.question_options.sort_by(&:number)[0]), {class: 'selectpicker regular', 'data-style': 'bg-white px-4 py-3', multiple: multiple, name: name_start + "[question_option][]"}) %>
    </div>
    <div class="col-md-3">
      <%= select_tag(:action_type, options_for_select(action_type_arr, type_default), {name: name_start + "[action_type]", class: 'action-type selectpicker narrow', 'data-style': 'bg-white px-4 py-3'}) %>
    </div>
    <div class="col-md-3">
      <div class="remove-dropdown">
        <%= select_tag(:remove_question_id, remove_question_group, {name: name_start + "[remove_question_id][]", class: 'selectpicker regular', multiple: true, 'data-style': 'bg-white px-4 py-3'}) %>
      </div>
      <div class="webhook-replacement display-off my-auto text-center">
        <%= link_to _('Edit email'), '#' %>
      </div>
    </div>
    <%= hidden_field_tag(name_start + "[number]", condition_no) %>

    <div class="col-md-3">
      <a href="#anotherurl" class="delete-condition"><%= _('Remove') %></a>
    </div>

    <%= render partial: 'org_admin/conditions/webhook_form', locals: {name_start: name_start, condition_no: condition_no} %>

  <% else %>
    <%
    qopt = condition[:question_option_id].any? ? QuestionOption.find_by(id: condition[:question_option_id].first): nil
    rques = condition[:remove_question_id].any? ? Question.find_by(id: condition[:remove_question_id].first) : nil
    %>
    <div class="col-md-3">
      <%= qopt[:text]&.slice(0, 25) %>
      <%= hidden_field_tag(name_start + "[question_option][]", condition[:question_option_id]) %>
    </div>
    <div class="col-md-3">
      <%= condition[:action_type] == 'remove' ? 'Remove' : 'Email' %>
      <%= hidden_field_tag(name_start + "[action_type]", condition[:action_type]) %>
    </div>
    <div class="col-md-3">
      <% if condition[:remove_question_id].is_a?(Array) && condition[:remove_question_id].any? %>
        Question <%= rques[:number] %>: <%= rques.text.gsub(%r{</?p>}, '').slice(0, 50) %>
        <%= hidden_field_tag(name_start + "[remove_question_id][]", condition[:remove_question_id]) %>
      <% else %>
        <%
        hook_tip = "Name: #{condition[:webhook_data]['name']}\nEmail: #{condition[:webhook_data]['email']}\n"
        hook_tip += "Subject: #{condition[:webhook_data]['subject']}\nMessage: #{condition[:webhook_data]['message']}"
        %>
        <span title="<%= hook_tip %>"><%= condition[:webhook_data]['email'] %></span>
        <%= hidden_field_tag(name_start + "[webhook-email]", condition[:webhook_data]['email']) %>
        <%= hidden_field_tag(name_start + "[webhook-name]", condition[:webhook_data]['name']) %>
        <%= hidden_field_tag(name_start + "[webhook-subject]", condition[:webhook_data]['subject']) %>
        <%= hidden_field_tag(name_start + "[webhook-message]", condition[:webhook_data]['message']) %>
      <% end %>
    </div>
    <%= hidden_field_tag(name_start + "[number]", condition_no) %>

    <div class="col-md-3">
      <a href="#anotherurl" class="delete-condition"><%= _('Remove') %></a>
    </div>
  <% end %>
</div>
