<%
url = @api_client.new_record? ? super_admin_api_clients_path : super_admin_api_client_path(@api_client)
method = @api_client.new_record? ? :post : :put
orgs = Org.includes(identifiers: [:identifier_scheme]).where(is_other: false)

redirect_uri_tooltip = _("Only applicable to OAuth enabled API endpoints (e.g. v2+). The redirect URI is the address that will be sent the user's authorization code once they have approved the integration via OAuth.")
tooltip_for_trusted = _("The API Client is a trusted external application and will be able to access read/edit/create/delete any data without having to acquire the User's authorization via OAuth.")
scope_information = sanitize(_("Scopes are not applicable to API v0 or v1. By default all API Clients have access to the 'public' scope which allows them to fetch the list of templates and read any publicly visible plans. See the %{link_to_v2_wiki} for details on scopes.") % { link_to_v2_wiki: "<a href=\"#{Rails.configuration.x.application.api_documentation_urls[:v2]}\" target=\"_blank\">API V2 wiki</a>" })
%>

<%= form_for @api_client, url: url, method: method,
                          html: { class: 'api_client' } do |f| %>
  <div class="row">
    <div class="form-group col-xs-4">
      <%= f.label :name, _('Name'), class: 'control-label' %>
      <%= f.text_field :name, class: 'form-control', aria: { required: true } %>
    </div>
    <div class="form-group col-xs-4">
      <%= f.label :homepage, _('Homepage'), class: 'control-label' %>
      <%= f.url_field :homepage, class: 'form-control' %>
    </div>
  </div>
  <div class="row">
    <div class="form-group col-xs-8">
      <%= f.label :description, _('Description'), class: 'control-label' %>
      <%= f.text_area :description, class: 'form-control api-client-text' %>
    </div>
  </div>
  <div class="row">
    <div class="form-group col-xs-4">
      <%= f.label :contact_email, _('Contact Name'), class: 'control-label' %>
      <%= f.text_field :contact_name, class: 'form-control' %>
    </div>
    <div class="form-group col-xs-4">
      <%= f.label :contact_email, _('Contact Email'), class: 'control-label' %>
      <%= f.email_field :contact_email, class: 'form-control', aria: { required: true } %>
    </div>
  </div>
  <div class="row">
    <div id="api-client-org-controls" class="form-group col-xs-8">
      <%= render partial: "shared/org_selectors/local_only",
                 locals: { form: f, default_org: @api_client.org, orgs: orgs, required: false } %>
    </div>
  </div>

  <div class="row">
    <div class="form-group col-xs-4">
      <%= f.label :redirect_uri, _('Redirect URI'), class: 'control-label' %>
      <%= f.url_field :redirect_uri, class: 'form-control', aria: { required: true },
                                     placeholder: 'http://localhost:3000/oauth2/callback',
                                     data: { toggle: "tooltip" }, title: redirect_uri_tooltip %>
    </div>
    <div class="form-group col-xs-4">
      <%= f.label :client_id, _('Last accessed on'), class: 'control-label' %>
      <% date = @api_client.last_access.present? ? @api_client.last_access.utc.to_s  : _("Never") %>
      <%= f.text_field :last_access, class: 'form-control', disabled: true,
                                      value: date %>
    </div>
  </div>
  <div class="row">
    <div class="form-group col-xs-2">
      <%= f.label :callback_method, _('Callback method'), class: 'control-label' %>
      <% http_methods = ApiClient.callback_methods.map { |k, _v| [k.humanize, k] } %>
      <%= f.select :callback_method, options_for_select(http_methods, f.object.callback_method),
                   { selected: f.object.callback_method || 0 }, { class: "form-control" } %>
    </div>
    <div class="form-group col-xs-6">
      <%= f.label :callback_uri, _('Callback URI'), class: 'control-label' %>
      <%= f.url_field :callback_uri, class: 'form-control', rows: 3,
                                     placeholder: 'http://localhost:3000/dmps/%{id}',
                                     data: { toggle: "tooltip" }, title: callback_uri_tooltip %>
      <p><%= _("If you would like the DMP ID to be used in the callback URI, please use the `%{id}` placeholder.") %></p>
    </div>
  </div>

  <% unless @api_client.new_record? %>
    <div class="row" id="api-client-credentials">
      <div class="form-group col-xs-4">
        <%= f.label :client_id, _('Client ID'), class: 'control-label' %>
        <%= f.email_field :client_id, class: 'form-control', disabled: true %>
      </div>
      <div class="form-group col-xs-4">
        <%= f.label :client_secret, _('Client Secret'), class: 'control-label' %>
        <%= f.email_field :client_secret, class: 'form-control', disabled: true %>
      </div>
    </div>
  <% end %>

  <div class="form-group row trusted-api-client">
    <div class="form-group col-md-9">
      <div class="col-md-4">
        <div class="checkbox" data-toggle="tooltip" title="<%= tooltip_for_trusted %>">
          <%= f.check_box :trusted %>
          <%= _("This API client is trusted to access all data.") %>
        </div>
      </div>
    </div>
  </div>

  <div class="form-group row oauth-scopes">
    <div class="col-md-9">
      <fieldset>
        <legend><%= _("Scopes") %></legend>

        <% Doorkeeper.config.optional_scopes.each do |scope| %>
          <div class="col-md-3">
            <div class="checkbox" data-toggle="tooltip" title="<%= tooltip_for_scope(scope) %>">
              <%= f.check_box :scopes, { multiple: true, checked: @api_client.scopes.include?(scope) }, scope %>
              <%= label_for_scope(scope) %>
            </div>
          </div>
        <% end %>
      </fieldset>
    </div>
  </div>

  <div class="form-group row oauth-scopes">
    <div class="form-group col-md-9">
      <br>
      <%= scope_information %>
    </div>
  </div>

  <div class="form-group row">
    <div class="col-md-8">
      <%= f.button _('Save'), class: 'btn btn-default', type: 'submit' %>

      <% unless @api_client.new_record? %>
        <%= link_to _("Refresh client secret"),
                    refresh_credentials_super_admin_api_client_path(@api_client),
                    class: "btn btn-default", remote: true %>

        <%= link_to _("Email credentials to contact"),
                    email_credentials_super_admin_api_client_path(@api_client),
                    class: "btn btn-default", remote: true %>

        <%= link_to(
              _('Delete'),
              super_admin_api_client_path(@api_client),
              class: 'btn btn-default',
              method: :delete,
              data: { confirm: _('Are you sure you want to delete the API client: "%{name}"') % { name: @api_client.name }}) %>
      <% end %>

      <%= link_to _('Cancel'), super_admin_api_clients_path, class: 'btn btn-default', role: 'button' %>
    </div>
  </div>
<% end %>
