<%#
Devise Sign up form arrived at after the user enters their email and we determine
that they do NOT have an existing account
%>
<%= form_with model: resource, url: user_registration_path, method: :post, local: true do |form| %>
  <h2><%= _("Sign up") %></h2>

  <span class="form-group">
    <%= form.label(:email, _('Email address'), class: "control-label", id: "sign-in-email-lbl") %>
    <%= form.email_field(:disabled_email, class: "form-control", value: resource.email,
                         aria: {
                           required: true,
                           labelledby: "sign-in-email-lbl"
                         },
                         disabled: "disabled") %>
    <%= form.hidden_field(:email, value: resource.email) %>
  </span>

  <% if @user.org.present? && @user.org.shibbolized? %>
    <%# The Org is Shibbolized so display the Institutional Sign in %>
    <%= _("Your address is associated with:") %>

    <h3><%= @user.org.name %></h3>
    <%= form.hidden_field :org_id, value: @user.org_id %>
    <%= form.submit _("Sign in with Institution to Continue"), class: "btn btn-default" %>

  <% else %>
    <%# Display the standard Sign up form %>
    <span class="form-group">
      <%= form.label(:firstname, _('First Name'), class: "control-label") %>
      <%= form.text_field(:firstname, aria: { required: true }, spellcheck: false,
                          autocomplete: "off",
                          class: "form-control #{auth_has_error?(:firstname) ? 'error' : ''}") %>
    </span>
    <span class="form-group">
      <%= form.label(:surname, _('Last Name'), class: "control-label") %>
      <%= form.text_field(:surname, aria: { required: true }, spellcheck: false,
                          autocomplete: "off",
                          class: "form-control #{auth_has_error?(:surname) ? 'error' : ''}") %>
    </span>

    <span id="create-account-org-controls" class="form-group">
      <%= render partial: "shared/org_autocomplete",
                 locals: { form: form,
                           default_org: @user&.org,
                           required: true,
                           classes: "#{auth_has_error?(:org) ? 'error' : ''}",
                           label: _("Institution") } %>
      <script type="text/javascript">
        initAutoComplete('#org_autocomplete_name');
      </script>
    </span>
    <span id="password-controls" class="form-group">
      <%= form.label(:password, _('Password'), class: "control-label checkbox-label") %>
      <%= form.password_field(:password, aria: { required: true },
                              class: "form-control #{auth_has_error?(:password) ? 'error' : ''}") %>
      <%= form.label(:password_toggle, class: "checkbox-label") do %>
        <%= check_box_tag("passwords_toggle_sign_up", nil, false, class: "passwords_toggle" ) %>
        <%= _('Show password') %>
      <% end %>
    </span>
    <br>
    <span class="form-group">
      <%= form.label(:accept_terms) do %>
        <%= form.check_box(:accept_terms, aria: { required: true },
                          class: "#{auth_has_error?(:accept_terms) ? 'error' : ''}") %>
        <%= _('I accept the') %>
        <%= link_to _('terms and conditions'), terms_path %>
      <% end %>
    </span>

    <span class="form-group">
      <% if Rails.configuration.x.recaptcha.enabled %>
        <div class="form-group">
          <%= label_tag(nil, _('Security check')) %>
          <%= recaptcha_tags %>
        </div>
      <% end %>
    </span>

    <%= form.submit _("Sign up"), class: "btn btn-default" %>
  <% end %>
<% end %>
<p>
  <%= sanitize(_("This will create a new account. If you already have an account, %{go_back_link} to try a different email address, or %{contact_us_link}.") % {
    go_back_link: link_to(_("go back"), root_path),
    contact_us_link: link_to(_("contact us"), contact_us_path)
  }) %>
</p>

<%= render partial: "users/shared/links", locals: { show_contact_us: false } %>
